<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forcepoint Documentation Mind Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --fp-green: #00af9a;
            --fp-dark-green: #008575; /* WCAG Compliant for text on white */
            --fp-navy: #1d252c;
            --fp-gray: #636569;
            --fp-light: #f5f6f6;
            --fp-accent-blue: #00bce4;
            --fp-error: #eb0000; /* WCAG Compliant red */
        }
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background-color: var(--fp-light); 
            margin: 0; 
            padding: 0;
            color: var(--fp-navy);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            background-color: var(--fp-navy);
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }
        header h1 { margin: 0; font-size: 1.25rem; font-weight: 600; }
        
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar for Categories */
        #sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow-y: auto;
            z-index: 50;
        }
        #sidebar h2 { font-size: 0.9rem; text-transform: uppercase; color: var(--fp-gray); letter-spacing: 0.05em; margin-bottom: 1rem; }
        .sidebar-item {
            padding: 0.6rem 0.8rem;
            margin-bottom: 0.2rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-item:hover { background: var(--fp-light); }
        .sidebar-item.active { background: var(--fp-light); font-weight: 600; color: var(--fp-dark-green); }

        .btn {
            background-color: var(--fp-navy); /* Switched to navy for better contrast with white text */
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        .btn:hover {
            background-color: #2c3a47;
            border-color: var(--fp-accent-blue);
        }
        .btn-primary {
            background-color: var(--fp-green);
            color: var(--fp-navy); /* Dark text on green for contrast */
            border: none;
        }
        .btn-primary:hover {
            background-color: #00caaf;
        }

        #viz-container {
            flex: 1;
            background: white;
            cursor: grab;
            position: relative;
        }
        #viz-container:active {
            cursor: grabbing;
        }

        /* D3 Styles */
        .node circle {
            fill: #fff;
            stroke: var(--fp-green);
            stroke-width: 2.5px;
            cursor: pointer;
            transition: r 0.2s;
        }
        .node:hover circle {
            r: 8;
            stroke: var(--fp-accent-blue);
        }
        .node text {
            font-size: 13px;
            fill: var(--fp-navy);
            cursor: pointer;
            transition: font-weight 0.2s;
        }
        .node:hover text {
            fill: var(--fp-dark-green);
            font-weight: 600;
        }
        .link {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 2px;
            transition: stroke 0.2s;
        }
        .link.active {
            stroke: var(--fp-accent-blue);
            stroke-width: 3px;
        }

        /* Tooltip - Reimagined as a Card */
        .tooltip {
            position: absolute;
            padding: 12px 16px;
            font-size: 13px;
            background: white;
            color: var(--fp-navy);
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border: 1px solid #e0e0e0;
            max-width: 250px;
            z-index: 1000;
        }
        .tooltip-title { font-weight: 700; margin-bottom: 4px; color: var(--fp-navy); }
        .tooltip-url { font-size: 11px; color: var(--fp-gray); word-break: break-all; }

        /* Controls */
        .controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 8px;
            border: 1px solid #eee;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            color: var(--fp-navy);
            font-weight: bold;
            z-index: 100;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid var(--fp-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Focus Styles */
        .btn:focus-visible {
            outline: 2px solid var(--fp-navy);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <header role="banner">
        <h1>Forcepoint Documentation Navigator</h1>
        <nav>
            <a href="https://help.forcepoint.com" class="btn" target="_blank">View Official Docs</a>
        </nav>
    </header>

    <div class="main-layout">
        <aside id="sidebar" aria-label="Product Categories">
            <h2>Products</h2>
            <div id="category-list">
                <!-- Categories will be populated dynamically -->
            </div>
        </aside>

        <main id="viz-container" role="main">
            <div class="loading-overlay">
                <div class="spinner"></div>
                <div>Loading documentation map...</div>
            </div>
            <div class="tooltip" id="tooltip"></div>
            
            <div class="controls" role="group" aria-label="Map Controls">
                <button class="btn" onclick="expandAll()" aria-label="Expand all nodes">Expand All</button>
                <button class="btn" onclick="collapseAll()" aria-label="Collapse all nodes">Collapse All</button>
                <button class="btn" onclick="resetZoom()" aria-label="Reset zoom and center">Reset</button>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const width = window.innerWidth;
        const height = window.innerHeight - 70;
        const margin = {top: 20, right: 120, bottom: 20, left: 120};
        const dx = 35; // vertical spacing
        const dy = 280; // horizontal spacing

        let root;
        let svg;
        let g;
        let tree;
        let zoom;

        // Load data
        d3.json("d3-data.json").then(data => {
            // Remove loading indicator
            d3.select(".loading-overlay").remove();

            root = d3.hierarchy(data);
            root.x0 = height / 2;
            root.y0 = 0;

            // Populate Sidebar
            populateSidebar(root.children);

            // Collapse all initially except root
            root.descendants().forEach((d, i) => {
                d.id = i;
                if (d.depth > 0) {
                    if (d.children) {
                        d._children = d.children;
                        d.children = null;
                    }
                }
            });

            // Initialize Tree Layout
            tree = d3.tree().nodeSize([dx, dy]);

            // Create SVG
            svg = d3.select("#viz-container").append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", [0, 0, width, height]);

            g = svg.append("g")
                .attr("transform", `translate(${margin.left},${height/2})`);

            // Zoom behavior
            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom);
            resetZoom();

            update(root);
        }).catch(err => {
            console.error("Error loading data:", err);
            const container = document.getElementById('viz-container');
            container.innerHTML = `
                <div class="loading-overlay" style="color: var(--fp-navy);">
                    <div style="font-size: 2rem; margin-bottom: 0;">⚠️</div>
                    <div>Error loading mind map data.</div>
                    <div style="font-weight: normal; font-size: 0.9rem; color: var(--fp-error);">Please ensure d3-data.json exists.</div>
                </div>
            `;
        });

        function populateSidebar(products) {
            const list = d3.select("#category-list");
            products.sort((a, b) => a.data.name.localeCompare(b.data.name))
                .forEach(p => {
                    list.append("div")
                        .attr("class", "sidebar-item")
                        .text(p.data.name)
                        .on("click", () => {
                            jumpToNode(p);
                        });
                });
        }

        function jumpToNode(d) {
            // Expand parents
            let current = d;
            while (current.parent) {
                if (current.parent._children) {
                    current.parent.children = current.parent._children;
                    current.parent._children = null;
                }
                current = current.parent;
            }
            
            // Expand the target node itself
            if (d._children) {
                d.children = d._children;
                d._children = null;
            }

            update(d);

            // Zoom and center
            const transform = d3.zoomIdentity
                .translate(margin.left, height / 2 - d.x)
                .scale(1);
            
            svg.transition().duration(750).call(zoom.transform, transform);
            
            // Highlight sidebar item
            d3.selectAll(".sidebar-item").classed("active", false);
            d3.selectAll(".sidebar-item").filter(function() {
                return d3.select(this).text() === d.data.name;
            }).classed("active", true);
        }

        function update(source) {
            const duration = 250;
            const nodes = root.descendants().reverse();
            const links = root.links();

            tree(root);

            const transition = svg.transition().duration(duration);

            const node = g.selectAll("g.node")
                .data(nodes, d => d.id);

            const nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .on("click", (event, d) => {
                    if (d.children) {
                        d._children = d.children;
                        d.children = null;
                    } else {
                        d.children = d._children;
                        d._children = null;
                    }
                    update(d);
                });

            nodeEnter.append("circle")
                .attr("r", 5)
                .style("fill", d => d._children ? "var(--fp-green)" : "#fff");

            nodeEnter.append("text")
                .attr("dy", "0.31em")
                .attr("x", d => d.children || d._children ? -10 : 10)
                .attr("text-anchor", d => d.children || d._children ? "end" : "start")
                .text(d => d.data.name)
                .clone(true).lower()
                .attr("stroke-linejoin", "round")
                .attr("stroke-width", 3)
                .attr("stroke", "white");

            nodeEnter.select("text")
                .on("click", (event, d) => {
                    if (d.data.url) {
                        event.stopPropagation();
                        window.open(d.data.url, '_blank');
                    }
                })
                .on("mouseover", (event, d) => {
                     const tooltip = d3.select("#tooltip");
                     tooltip.style("opacity", 1)
                            .html(`<div class="tooltip-title">${d.data.name}</div>
                                   ${d.data.url ? `<div class="tooltip-url">${d.data.url}</div>` : ""}`);
                     
                     tooltip.style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", () => {
                     d3.select("#tooltip").style("opacity", 0);
                });

            const nodeUpdate = node.merge(nodeEnter).transition(transition)
                .attr("transform", d => `translate(${d.y},${d.x})`);

            nodeUpdate.select("circle")
                .style("fill", d => d._children ? "var(--fp-green)" : "#fff");

            const nodeExit = node.exit().transition(transition).remove()
                .attr("transform", d => `translate(${source.y},${source.x})`);

            const link = g.selectAll("path.link")
                .data(links, d => d.target.id);

            const linkEnter = link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", d => {
                    const o = {x: source.x0, y: source.y0};
                    return diagonal({source: o, target: o});
                });

            link.merge(linkEnter).transition(transition)
                .attr("d", diagonal);

            link.exit().transition(transition).remove()
                .attr("d", d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal({source: o, target: o});
                });

            root.eachBefore(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        function diagonal(d) {
            return `M${d.source.y},${d.source.x}
                    C${(d.source.y + d.target.y) / 2},${d.source.x}
                     ${(d.source.y + d.target.y) / 2},${d.target.x}
                     ${d.target.y},${d.target.x}`;
        }

        function expandAll() {
            if(!root) return;
            root.each(d => {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
            });
            update(root);
        }

        function collapseAll() {
            if(!root) return;
            root.descendants().forEach(d => {
                if (d.depth > 0 && d.children) {
                    d._children = d.children;
                    d.children = null;
                }
            });
            update(root);
            resetZoom();
        }

        function resetZoom() {
             svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(margin.left, height/2).scale(0.8));
        }
    </script>
</body>
</html>