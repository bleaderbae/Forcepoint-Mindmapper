<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forcepoint Documentation Mind Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --fp-green: #00af9a;
            --fp-dark-green: #007565;
            --fp-navy: #1d252c;
            --fp-gray: #636569;
            --fp-light: #f5f6f6;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--fp-light); 
            margin: 0; 
            padding: 0;
            color: var(--fp-navy);
            overflow: hidden; /* Hide scrollbars, we use zoom/pan */
        }
        header {
            background-color: var(--fp-navy);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            position: relative;
        }
        header h1 { margin: 0; font-size: 1.5rem; }
        .btn {
            background-color: var(--fp-green);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 2px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
            font-size: 0.9rem;
        }
        .btn:hover {
            background-color: var(--fp-dark-green);
        }
        #viz-container {
            width: 100vw;
            height: calc(100vh - 70px); /* Adjust based on header height */
            background: white;
            cursor: grab;
        }
        #viz-container:active {
            cursor: grabbing;
        }

        /* D3 Styles */
        .node circle {
            fill: #fff;
            stroke: var(--fp-green);
            stroke-width: 2px;
            cursor: pointer;
        }
        .node circle:hover {
            fill: var(--fp-green);
            stroke: var(--fp-dark-green);
        }
        .node text {
            font: 12px sans-serif;
            fill: var(--fp-navy);
            cursor: pointer;
        }
        .node text:hover {
            font-weight: bold;
            text-decoration: underline;
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font: 12px sans-serif;
            background: var(--fp-navy);
            color: #fff;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* Controls */
        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Forcepoint Documentation Mind Map</h1>
        <div>
            <a href="mermaid.html" class="btn" style="margin-right: 10px; background-color: var(--fp-gray);">Static View</a>
            <a href="https://help.forcepoint.com" class="btn" target="_blank">View Original Docs</a>
        </div>
    </header>

    <div id="viz-container"></div>
    <div class="tooltip" id="tooltip"></div>

    <div class="controls">
        <button class="btn" onclick="expandAll()">Expand All</button>
        <button class="btn" onclick="collapseAll()">Collapse All</button>
        <button class="btn" onclick="resetZoom()">Reset Zoom</button>
    </div>

    <script>
        // Configuration
        const width = window.innerWidth;
        const height = window.innerHeight - 70;
        const margin = {top: 20, right: 120, bottom: 20, left: 120};
        const dx = 20; // vertical spacing
        const dy = 200; // horizontal spacing

        let root;
        let svg;
        let g;
        let tree;
        let zoom;

        // Load data
        d3.json("d3-data.json").then(data => {
            root = d3.hierarchy(data);

            // Collapse all initially except root's immediate children
            root.descendants().forEach((d, i) => {
                d.id = i;
                if (d.depth > 1) d._children = d.children; // preserve children
                // if (d.depth > 1) d.children = null; // hide children initially?
                // Let's verify collapse logic below
            });

            // Initialize Tree Layout
            tree = d3.tree().nodeSize([dx, dy]);

            // Create SVG
            svg = d3.select("#viz-container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [0, 0, width, height]);

            g = svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 12)
                .attr("transform", `translate(${margin.left},${height/2})`); // Start centered vertically

            // Zoom behavior
            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom)
               .call(zoom.transform, d3.zoomIdentity.translate(margin.left, height/2).scale(1));

            update(root);
        }).catch(err => {
            console.error("Error loading data:", err);
            document.getElementById('viz-container').innerHTML = `<p style="padding:2rem; color:red;">Error loading mind map data. Please insure d3-data.json exists.</p>`;
        });

        function update(source) {
            const duration = 250;
            const nodes = root.descendants().reverse();
            const links = root.links();

            // Compute the new tree layout.
            tree(root);

            let left = root;
            let right = root;
            root.eachBefore(node => {
                if (node.x < left.x) left = node;
                if (node.x > right.x) right = node;
            });

            const height = right.x - left.x + margin.top + margin.bottom;

            const transition = svg.transition()
                .duration(duration)
                .tween("resize", window.ResizeObserver ? null : () => () => svg.dispatch("toggle"));

            // Update the nodes…
            const node = g.selectAll("g.node")
                .data(nodes, d => d.id);

            // Enter any new nodes at the parent's previous position.
            const nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .on("click", (event, d) => {
                    if (d.children) {
                        d._children = d.children;
                        d.children = null;
                    } else {
                        d.children = d._children;
                        d._children = null;
                    }
                    update(d);
                });

            nodeEnter.append("circle")
                .attr("r", 5)
                .style("fill", d => d._children ? "#00af9a" : "#fff");

            nodeEnter.append("text")
                .attr("dy", "0.31em")
                .attr("x", d => d.children || d._children ? -8 : 8)
                .attr("text-anchor", d => d.children || d._children ? "end" : "start")
                .text(d => d.data.name)
                .clone(true).lower()
                .attr("stroke-linejoin", "round")
                .attr("stroke-width", 3)
                .attr("stroke", "white");

            // Add click to open URL if leaf node (or ctrl+click)
            nodeEnter.select("text")
                .on("click", (event, d) => {
                    if (d.data.url) {
                        // If holding Ctrl/Cmd, open link
                        // Or if it's a leaf node.
                        // But clicking text should probably navigate?
                        // But we also need click to expand/collapse.
                        // Let's make circle toggle expand, text navigate.
                        event.stopPropagation();
                        if(d.data.url) window.open(d.data.url, '_blank');
                    } else {
                        // Toggle expand if no URL
                        if (d.children) {
                            d._children = d.children;
                            d.children = null;
                        } else {
                            d.children = d._children;
                            d._children = null;
                        }
                        update(d);
                    }
                })
                .on("mouseover", (event, d) => {
                     const tooltip = d3.select("#tooltip");
                     if (d.data.url) {
                         tooltip.style("opacity", 1)
                                .html(`${d.data.name}<br/><span style="color:#ccc;font-size:10px">${d.data.url}</span>`)
                                .style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY - 28) + "px");
                     }
                })
                .on("mouseout", () => {
                     d3.select("#tooltip").style("opacity", 0);
                });


            // Transition nodes to their new position.
            const nodeUpdate = node.merge(nodeEnter).transition(transition)
                .attr("transform", d => `translate(${d.y},${d.x})`)
                .attr("fill-opacity", 1)
                .attr("stroke-opacity", 1);

            nodeUpdate.select("circle")
                .style("fill", d => d._children ? "#00af9a" : "#fff");

            // Transition exiting nodes to the parent's new position.
            const nodeExit = node.exit().transition(transition).remove()
                .attr("transform", d => `translate(${source.y},${source.x})`)
                .attr("fill-opacity", 0)
                .attr("stroke-opacity", 0);

            // Update the links…
            const link = g.selectAll("path.link")
                .data(links, d => d.target.id);

            // Enter any new links at the parent's previous position.
            const linkEnter = link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", d => {
                    const o = {x: source.x0, y: source.y0};
                    return diagonal({source: o, target: o});
                });

            // Transition links to their new position.
            link.merge(linkEnter).transition(transition)
                .attr("d", diagonal);

            // Transition exiting links to the parent's new position.
            link.exit().transition(transition).remove()
                .attr("d", d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal({source: o, target: o});
                });

            // Stash the old positions for transition.
            root.eachBefore(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        function diagonal(d) {
            return `M${d.source.y},${d.source.x}
                    C${(d.source.y + d.target.y) / 2},${d.source.x}
                     ${(d.source.y + d.target.y) / 2},${d.target.x}
                     ${d.target.y},${d.target.x}`;
        }

        // Control functions
        function expandAll() {
            if(!root) return;
            root.each(d => {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
            });
            update(root);
            // Re-center
            // svg.call(zoom.transform, d3.zoomIdentity.translate(margin.left, height/2).scale(0.5));
        }

        function collapseAll() {
            if(!root) return;
            root.each(d => {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                }
            });
            // Keep root expanded?
            if(root._children) {
                root.children = root._children;
                root._children = null;
            }
            update(root);
        }

        function resetZoom() {
             svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(margin.left, height/2).scale(1));
        }

        // Initialize source position for root
        // Done inside d3.json callback after root is created.

    </script>
</body>
</html>